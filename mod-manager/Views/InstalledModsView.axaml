<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             x:Class="TerrariaModManager.Views.InstalledModsView">
    <Grid Margin="24,24,24,36" RowDefinitions="Auto,Auto,*,Auto">

        <Grid Grid.Row="0" Margin="0,0,0,12">
            <TextBlock Text="Installed Mods" Classes="section-header"/>
            <StackPanel Orientation="Horizontal" HorizontalAlignment="Right" VerticalAlignment="Top">
                <Button Content="Install Local..." Classes="secondary"
                        Command="{Binding InstallLocalCommand}" Margin="0,0,8,0"/>
                <Button Content="Refresh" Classes="secondary"
                        Command="{Binding RefreshCommand}"/>
            </StackPanel>
        </Grid>

        <!-- Loading indicator for update check -->
        <TextBlock Grid.Row="0" Text="Checking for updates..." FontSize="11"
                   Foreground="{StaticResource TextSecondaryBrush}"
                   VerticalAlignment="Bottom"
                   IsVisible="{Binding IsCheckingUpdates}"/>

        <!-- Updates Available section -->
        <Border Grid.Row="1" Classes="card" Margin="0,0,0,12"
                IsVisible="{Binding HasUpdates}"
                BorderBrush="#FF3D2E00">
            <StackPanel>
                <Grid Margin="0,0,0,8">
                    <TextBlock Text="{Binding UpdatesAvailable, StringFormat='Updates Available ({0})'}"
                               FontSize="13" FontWeight="SemiBold"
                               Foreground="{StaticResource WarningBrush}"
                               VerticalAlignment="Center"/>
                    <Button Content="Update All" Classes="primary"
                            Command="{Binding UpdateAllCommand}"
                            HorizontalAlignment="Right" Padding="12,6" FontSize="12"/>
                </Grid>
                <ItemsControl ItemsSource="{Binding UpdateMods}">
                    <ItemsControl.ItemTemplate>
                        <DataTemplate>
                            <Border Background="{StaticResource BgDarkBrush}" CornerRadius="4"
                                    Padding="10,8" Margin="0,2">
                                <Grid ColumnDefinitions="*,Auto,Auto">
                                    <StackPanel Grid.Column="0">
                                        <TextBlock Text="{Binding Name}" FontSize="13" FontWeight="SemiBold"
                                                   Foreground="{StaticResource WarningBrush}"/>
                                    </StackPanel>
                                    <StackPanel Grid.Column="1" Orientation="Horizontal" VerticalAlignment="Center" Margin="16,0">
                                        <TextBlock Text="{Binding Version}" Foreground="{StaticResource TextSecondaryBrush}" FontSize="12"/>
                                        <TextBlock Text=" → " Foreground="{StaticResource TextSecondaryBrush}" FontSize="12"/>
                                        <TextBlock Text="{Binding LatestVersion}" Foreground="{StaticResource WarningBrush}" FontSize="12"
                                                   FontWeight="SemiBold"/>
                                    </StackPanel>
                                    <Button Grid.Column="2" Content="Update" Classes="primary"
                                            Command="{Binding $parent[UserControl].DataContext.UpdateSingleCommand}"
                                            CommandParameter="{Binding}"
                                            Padding="10,4" FontSize="11" Margin="12,0,0,0"/>
                                </Grid>
                            </Border>
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                </ItemsControl>
            </StackPanel>
        </Border>

        <Border Grid.Row="2" Classes="card">
            <Grid>
                <TextBlock Text="No mods installed yet.&#x0a;Use the Browse tab or click 'Download with Manager' on Nexus Mods."
                           Foreground="{StaticResource TextSecondaryBrush}" TextAlignment="Center"
                           HorizontalAlignment="Center" VerticalAlignment="Center"
                           IsVisible="{Binding Mods.Count, Converter={StaticResource CountToBool}, ConverterParameter=invert}"/>

                <ListBox ItemsSource="{Binding Mods}"
                         SelectionMode="Multiple"
                         SelectionChanged="OnSelectionChanged"
                         Classes="dark">
                    <ListBox.ItemTemplate>
                        <DataTemplate>
                            <StackPanel>
                                <!-- Section divider before disabled mods -->
                                <Border IsVisible="{Binding IsFirstDisabled}"
                                        BorderBrush="{StaticResource BorderColorBrush}"
                                        BorderThickness="0,1,0,0" Margin="0,8,0,4" Padding="0,8,0,0">
                                    <TextBlock Text="Disabled" FontSize="11" FontWeight="SemiBold"
                                               Foreground="{StaticResource TextSecondaryBrush}"/>
                                </Border>
                            <Grid Margin="4" ColumnDefinitions="*,Auto,Auto,Auto">
                                <StackPanel Grid.Column="0">
                                    <TextBlock Text="{Binding Name}" FontSize="14" FontWeight="SemiBold"
                                               Foreground="{Binding NameColor}"/>
                                    <TextBlock Text="{Binding Description}" Foreground="{StaticResource TextSecondaryBrush}"
                                               FontSize="11" TextTrimming="CharacterEllipsis" MaxWidth="500"
                                               HorizontalAlignment="Left"/>
                                </StackPanel>
                                <TextBlock Grid.Column="1" Text="{Binding Author}" Foreground="{StaticResource TextSecondaryBrush}"
                                           VerticalAlignment="Center" Margin="16,0"/>
                                <StackPanel Grid.Column="2" Orientation="Horizontal" VerticalAlignment="Center" Margin="16,0">
                                    <TextBlock Text="{Binding Version}" Foreground="{Binding VersionColor}" FontSize="12"/>
                                    <!-- Update badge -->
                                    <Border Background="#FF3D2E00" CornerRadius="3"
                                            Padding="6,2" Margin="6,0,0,0" VerticalAlignment="Center"
                                            IsVisible="{Binding HasUpdate}">
                                        <TextBlock Text="{Binding LatestVersion, StringFormat='→ {0}'}"
                                                   FontSize="10" Foreground="{StaticResource WarningBrush}"/>
                                    </Border>
                                </StackPanel>
                                <TextBlock Grid.Column="3" VerticalAlignment="Center" HorizontalAlignment="Right" FontSize="12"
                                           Text="{Binding StatusText}" Foreground="{Binding StatusColor}"
                                           MinWidth="100" TextAlignment="Center"/>
                            </Grid>
                            </StackPanel>
                        </DataTemplate>
                    </ListBox.ItemTemplate>
                </ListBox>
            </Grid>
        </Border>

        <!-- Action buttons -->
        <StackPanel Grid.Row="3" Orientation="Horizontal" Margin="0,12,0,0"
                    IsVisible="{Binding HasSelection}">
            <TextBlock Text="{Binding SelectionSummary}" VerticalAlignment="Center"
                       Foreground="{StaticResource TextSecondaryBrush}" FontSize="12"
                       Margin="0,0,12,0"/>
            <Button Content="Toggle Enable/Disable" Classes="secondary"
                    Command="{Binding ToggleEnabledCommand}" Margin="0,0,8,0"/>
            <Button Content="Open Folder" Classes="secondary"
                    Command="{Binding OpenModFolderCommand}" Margin="0,0,8,0"
                    IsVisible="{Binding HasSingleSelection}"/>
            <Button Content="Open on Nexus" Classes="secondary"
                    Command="{Binding OpenOnNexusCommand}" Margin="0,0,8,0"
                    IsVisible="{Binding HasSingleSelection}"/>
            <Button Content="Update" Classes="primary"
                    Command="{Binding UpdateModCommand}" Margin="0,0,8,0"
                    IsVisible="{Binding AnySelectedHasUpdate}"/>
            <Button Content="Uninstall" Classes="danger"
                    Command="{Binding UninstallKeepSettingsCommand}" Margin="0,0,4,0"/>
            <Button Content="Uninstall + Delete Settings" Classes="danger"
                    Command="{Binding UninstallCleanCommand}" FontSize="11"
                    IsVisible="{Binding AnySelectedHasSettings}"/>
        </StackPanel>
    </Grid>
</UserControl>
