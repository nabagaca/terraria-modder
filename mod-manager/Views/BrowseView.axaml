<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:asyncImageLoader="using:AsyncImageLoader"
             xmlns:html="using:TheArtOfDev.HtmlRenderer.Avalonia"
             x:Class="TerrariaModManager.Views.BrowseView">
    <Grid ColumnDefinitions="*,Auto">

        <!-- Main content area -->
        <Grid Grid.Column="0" Margin="12,24,12,36" RowDefinitions="Auto,Auto,*">

            <!-- Header -->
            <Grid Grid.Row="0" Margin="0,0,0,12">
                <TextBlock Text="Browse Nexus Mods" Classes="section-header"/>
                <StackPanel Orientation="Horizontal" HorizontalAlignment="Right" VerticalAlignment="Top">
                    <Button Content="Refresh" Classes="secondary"
                            Command="{Binding RefreshCommand}"/>
                </StackPanel>
            </Grid>

            <!-- Toolbar: search + feeds + sort + layout toggle -->
            <StackPanel Grid.Row="1" Margin="0,0,0,12">
                <!-- Search bar + hide installed + layout toggle -->
                <Grid Margin="0,0,0,8" ColumnDefinitions="*,Auto,Auto">
                    <TextBox Grid.Column="0" Text="{Binding SearchText, Mode=TwoWay}"
                             Watermark="Search by name, or paste a Nexus URL / mod ID"
                             Classes="dark"
                             KeyDown="OnSearchKeyDown"/>
                    <Button Grid.Column="1" Content="{Binding HideInstalledText}" Classes="secondary"
                            Command="{Binding ToggleHideInstalledCommand}"
                            Padding="10,6" FontSize="11" Margin="8,0,0,0"/>
                    <Button Grid.Column="2" Content="{Binding LayoutToggleText}" Classes="secondary"
                            Command="{Binding ToggleLayoutCommand}"
                            Padding="10,6" FontSize="11" Margin="4,0,0,0"/>
                </Grid>

                <!-- Feed + sort buttons (wrapping) -->
                <WrapPanel>
                    <!-- Feed tabs -->
                    <Button Content="All" Classes="secondary" Padding="10,5" FontSize="11"
                            Command="{Binding LoadAllCommand}" Margin="0,0,4,4"/>
                    <Button Content="Latest" Classes="secondary" Padding="10,5" FontSize="11"
                            Command="{Binding LoadLatestCommand}" Margin="0,0,4,4"/>
                    <Button Content="Trending" Classes="secondary" Padding="10,5" FontSize="11"
                            Command="{Binding LoadTrendingCommand}" Margin="0,0,4,4"/>
                    <Button Content="Updated" Classes="secondary" Padding="10,5" FontSize="11"
                            Command="{Binding LoadUpdatedCommand}" Margin="0,0,16,4"/>

                    <!-- Sort -->
                    <TextBlock Text="Sort:" Foreground="{StaticResource TextSecondaryBrush}"
                               VerticalAlignment="Center" Margin="0,0,6,4" FontSize="12"/>
                    <Button Content="Name" Classes="secondary" Padding="10,5"
                            Command="{Binding SortByNameCommand}" Margin="0,0,3,4" FontSize="11"/>
                    <Button Content="Downloads" Classes="secondary" Padding="10,5"
                            Command="{Binding SortByDownloadsCommand}" Margin="0,0,3,4" FontSize="11"/>
                    <Button Content="Updated" Classes="secondary" Padding="10,5"
                            Command="{Binding SortByUpdatedCommand}" Margin="0,0,3,4" FontSize="11"/>
                    <Button Content="Endorsements" Classes="secondary" Padding="10,5"
                            Command="{Binding SortByEndorsementsCommand}" Margin="0,0,0,4" FontSize="11"/>
                </WrapPanel>
            </StackPanel>

            <!-- Content area -->
            <Grid Grid.Row="2">
                <!-- No API key -->
                <TextBlock Text="Add your Nexus API key in Settings to browse mods."
                           Foreground="{StaticResource TextSecondaryBrush}" TextAlignment="Center"
                           HorizontalAlignment="Center" VerticalAlignment="Center"
                           IsVisible="{Binding !HasApiKey}"/>

                <!-- Loading -->
                <TextBlock Text="Loading..." Foreground="{StaticResource TextSecondaryBrush}"
                           HorizontalAlignment="Center" VerticalAlignment="Center"
                           IsVisible="{Binding IsLoading}"/>

                    <!-- Grid layout -->
                    <ScrollViewer VerticalScrollBarVisibility="Auto"
                                  IsVisible="{Binding IsGridLayout}">
                        <ItemsControl ItemsSource="{Binding Mods}">
                            <ItemsControl.ItemsPanel>
                                <ItemsPanelTemplate>
                                    <WrapPanel HorizontalAlignment="Center"/>
                                </ItemsPanelTemplate>
                            </ItemsControl.ItemsPanel>
                            <ItemsControl.ItemTemplate>
                                <DataTemplate>
                                    <Border Background="{StaticResource BgLightBrush}" CornerRadius="6"
                                            Margin="4" Width="260" Cursor="Hand"
                                            BorderThickness="0" Tapped="OnCardTapped">
                                        <Panel>
                                            <StackPanel>
                                                <!-- Thumbnail -->
                                                <Border CornerRadius="6,6,0,0" ClipToBounds="True" Height="150">
                                                    <Panel>
                                                        <asyncImageLoader:AdvancedImage
                                                            Source="{Binding PictureUrl}"
                                                            Stretch="UniformToFill"
                                                            Width="260" Height="150"/>
                                                        <TextBlock Text="No Image" FontSize="11"
                                                                   Foreground="{StaticResource TextSecondaryBrush}"
                                                                   HorizontalAlignment="Center" VerticalAlignment="Center"
                                                                   IsHitTestVisible="False"
                                                                   IsVisible="{Binding HasNoImage}"/>
                                                        <!-- Installed / Update badge overlay on thumbnail -->
                                                        <Border Background="{Binding BadgeBackground}"
                                                                CornerRadius="0,0,0,4" Padding="8,3"
                                                                HorizontalAlignment="Right" VerticalAlignment="Top"
                                                                IsHitTestVisible="False"
                                                                IsVisible="{Binding IsInstalled}">
                                                            <TextBlock Text="{Binding InstalledBadgeText}" FontSize="10"
                                                                       FontWeight="SemiBold"
                                                                       Foreground="{Binding BadgeForeground}"/>
                                                        </Border>
                                                    </Panel>
                                                </Border>
                                                <!-- Info -->
                                                <StackPanel Margin="12,8,12,10">
                                                    <TextBlock Text="{Binding Name}" FontSize="14" FontWeight="SemiBold"
                                                               TextTrimming="CharacterEllipsis"/>
                                                    <TextBlock Text="{Binding Author}" FontSize="11"
                                                               Foreground="{StaticResource TextSecondaryBrush}"
                                                               Margin="0,2,0,0"/>
                                                    <StackPanel Orientation="Horizontal" Margin="0,4,0,0">
                                                        <TextBlock Text="{Binding Version}" FontSize="11"
                                                                   Foreground="{StaticResource AccentBrush}" VerticalAlignment="Center"/>
                                                        <TextBlock Text=" Â· " Foreground="{StaticResource TextSecondaryBrush}" FontSize="11" VerticalAlignment="Center"/>
                                                        <TextBlock Text="{Binding Downloads, StringFormat='{}{0:N0} DLs'}"
                                                                   FontSize="11" Foreground="{StaticResource TextSecondaryBrush}" VerticalAlignment="Center"/>
                                                    </StackPanel>
                                                </StackPanel>
                                                <!-- Buttons -->
                                                <StackPanel Margin="12,0,12,10" Spacing="4">
                                                    <Button Content="{Binding InstallButtonText}" HorizontalAlignment="Stretch"
                                                            HorizontalContentAlignment="Center"
                                                            Classes="primary" Padding="8,5" FontSize="11"
                                                            Command="{Binding $parent[UserControl].DataContext.DownloadModCommand}"
                                                            CommandParameter="{Binding}"/>
                                                    <Button Content="View on Nexus" HorizontalAlignment="Stretch"
                                                            HorizontalContentAlignment="Center"
                                                            Classes="secondary" Padding="8,4" FontSize="11"
                                                            Command="{Binding $parent[UserControl].DataContext.OpenNexusPageCommand}"
                                                            CommandParameter="{Binding}"/>
                                                </StackPanel>
                                            </StackPanel>
                                            <!-- Left accent stripe for installed/update mods -->
                                            <Border Background="{Binding CardBorderColor}" Width="3"
                                                    HorizontalAlignment="Left" CornerRadius="6,0,0,6"
                                                    IsHitTestVisible="False"
                                                    IsVisible="{Binding IsInstalled}"/>
                                        </Panel>
                                    </Border>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>
                    </ScrollViewer>

                    <!-- List layout -->
                    <ListBox ItemsSource="{Binding Mods}"
                             SelectedItem="{Binding SelectedMod}"
                             Classes="dark"
                             IsVisible="{Binding IsListLayout}">
                        <ListBox.ItemTemplate>
                            <DataTemplate>
                                <Grid Margin="4" ColumnDefinitions="Auto,*,Auto,Auto,Auto" Cursor="Hand"
                                      Tapped="OnCardTapped">
                                    <!-- Thumbnail -->
                                    <Border Grid.Column="0" Width="48" Height="48" CornerRadius="4"
                                            ClipToBounds="True" Margin="0,0,12,0">
                                        <asyncImageLoader:AdvancedImage
                                            Source="{Binding PictureUrl}"
                                            Stretch="UniformToFill"
                                            Width="48" Height="48"/>
                                    </Border>
                                    <!-- Name + summary -->
                                    <StackPanel Grid.Column="1" VerticalAlignment="Center">
                                        <TextBlock Text="{Binding Name}" FontSize="14" FontWeight="SemiBold"/>
                                        <TextBlock Text="{Binding Summary}" Foreground="{StaticResource TextSecondaryBrush}"
                                                   FontSize="11" TextTrimming="CharacterEllipsis" MaxWidth="400"
                                                   HorizontalAlignment="Left"/>
                                    </StackPanel>
                                    <TextBlock Grid.Column="2" Text="{Binding Author}"
                                               Foreground="{StaticResource TextSecondaryBrush}"
                                               VerticalAlignment="Center" Margin="16,0" FontSize="12"/>
                                    <TextBlock Grid.Column="3" Text="{Binding Downloads, StringFormat='{}{0:N0}'}"
                                               Foreground="{StaticResource TextSecondaryBrush}"
                                               VerticalAlignment="Center" Margin="16,0" FontSize="12"/>
                                    <TextBlock Grid.Column="4" Text="{Binding Version}"
                                               Foreground="{StaticResource AccentBrush}"
                                               VerticalAlignment="Center" Margin="16,0" FontSize="12"/>
                                </Grid>
                            </DataTemplate>
                        </ListBox.ItemTemplate>
                    </ListBox>
            </Grid>

            <!-- Toast notification -->
            <Border Grid.Row="2" Background="{StaticResource AccentBrush}" CornerRadius="6"
                    Padding="16,10" HorizontalAlignment="Center" VerticalAlignment="Bottom"
                    Margin="0,0,0,16" IsVisible="{Binding IsToastVisible}"
                    IsHitTestVisible="False">
                <TextBlock Text="{Binding ToastMessage}" Foreground="White" FontSize="13"/>
            </Border>
        </Grid>

        <!-- Detail sidebar -->
        <Border Grid.Column="1" Background="{StaticResource BgMediumBrush}"
                BorderBrush="{StaticResource BorderColorBrush}" BorderThickness="1,0,0,0"
                Width="380" IsVisible="{Binding IsDetailOpen}">
            <Grid RowDefinitions="Auto,*">
                <!-- Close button -->
                <Button Grid.Row="0" Content="X" Classes="secondary"
                        HorizontalAlignment="Right" Margin="12,12"
                        Padding="8,4" FontSize="12" FontWeight="Bold"
                        Command="{Binding CloseDetailCommand}"/>

                <!-- Detail content -->
                <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto" Margin="0,0,0,16">
                    <StackPanel Margin="20,0,20,20">
                        <!-- Image -->
                        <Border CornerRadius="6" ClipToBounds="True" Margin="0,0,0,16"
                                IsVisible="{Binding DetailMod.PictureUrl, Converter={x:Static StringConverters.IsNotNullOrEmpty}, FallbackValue=False}">
                            <asyncImageLoader:AdvancedImage
                                Source="{Binding DetailMod.PictureUrl, FallbackValue=''}"
                                Stretch="Uniform" MaxHeight="220"/>
                        </Border>

                        <!-- Name -->
                        <TextBlock Text="{Binding DetailMod.Name}" FontSize="18" FontWeight="Bold"
                                   TextWrapping="Wrap" Margin="0,0,0,4"/>

                        <!-- Author -->
                        <TextBlock Text="{Binding DetailMod.Author}" FontSize="12"
                                   Foreground="{StaticResource TextSecondaryBrush}" Margin="0,0,0,12"/>

                        <!-- Stats row -->
                        <Border Background="{StaticResource BgLightBrush}" CornerRadius="6" Padding="12,8" Margin="0,0,0,12">
                            <Grid ColumnDefinitions="*,*,*">
                                <StackPanel Grid.Column="0" HorizontalAlignment="Center">
                                    <TextBlock Text="{Binding DetailMod.Version}" FontSize="12"
                                               Foreground="{StaticResource AccentBrush}" HorizontalAlignment="Center"/>
                                    <TextBlock Text="Version" FontSize="10"
                                               Foreground="{StaticResource TextSecondaryBrush}" HorizontalAlignment="Center"/>
                                </StackPanel>
                                <StackPanel Grid.Column="1" HorizontalAlignment="Center">
                                    <TextBlock Text="{Binding DetailMod.Downloads, StringFormat='{}{0:N0}'}" FontSize="12"
                                               HorizontalAlignment="Center"/>
                                    <TextBlock Text="Downloads" FontSize="10"
                                               Foreground="{StaticResource TextSecondaryBrush}" HorizontalAlignment="Center"/>
                                </StackPanel>
                                <StackPanel Grid.Column="2" HorizontalAlignment="Center">
                                    <TextBlock Text="{Binding DetailMod.EndorsementCount, StringFormat='{}{0:N0}'}" FontSize="12"
                                               HorizontalAlignment="Center"/>
                                    <TextBlock Text="Endorsements" FontSize="10"
                                               Foreground="{StaticResource TextSecondaryBrush}" HorizontalAlignment="Center"/>
                                </StackPanel>
                            </Grid>
                        </Border>

                        <!-- Install state badge -->
                        <Border Background="{StaticResource BgLightBrush}" CornerRadius="4" Padding="8,4" Margin="0,0,0,12"
                                HorizontalAlignment="Left"
                                IsVisible="{Binding DetailMod.IsInstalled}">
                            <TextBlock FontSize="11" Foreground="{StaticResource AccentBrush}">
                                <TextBlock.Text>
                                    <MultiBinding StringFormat="Installed v{0}">
                                        <Binding Path="DetailMod.InstalledVersion"/>
                                    </MultiBinding>
                                </TextBlock.Text>
                            </TextBlock>
                        </Border>

                        <!-- Buttons (above description) -->
                        <Button Content="{Binding DetailMod.InstallButtonText}" HorizontalAlignment="Stretch"
                                HorizontalContentAlignment="Center"
                                Classes="primary" Padding="16,10" FontSize="13"
                                Command="{Binding DownloadModCommand}"
                                CommandParameter="{Binding DetailMod}" Margin="0,0,0,8"/>
                        <Button Content="View on Nexus" HorizontalAlignment="Stretch"
                                HorizontalContentAlignment="Center"
                                Classes="secondary" Padding="16,8" FontSize="12"
                                Command="{Binding OpenNexusPageCommand}"
                                CommandParameter="{Binding DetailMod}" Margin="0,0,0,16"/>

                        <!-- Description loading -->
                        <TextBlock Text="Loading description..." FontSize="12"
                                   Foreground="{StaticResource TextSecondaryBrush}"
                                   IsVisible="{Binding IsDetailLoading}" Margin="0,0,0,8"/>

                        <!-- Description (rendered HTML from BBCode) -->
                        <html:HtmlLabel Text="{Binding DetailDescription}"
                                        Background="Transparent"
                                        Margin="0,0,0,0"/>
                    </StackPanel>
                </ScrollViewer>
            </Grid>
        </Border>
    </Grid>
</UserControl>
